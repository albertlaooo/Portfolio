;/*FB_PKG_DELIM*/

__d("LSUpdateAttachmentCdnUrl.nop",["ExecutionEnvironment","FBLogger","I64","LSIntEnum","LSMEBTaskCreationSource","MAWAsyncEBMediaDownloadPromise","MAWBridgeFireAndForget","MAWJobDefinitions","MAWMediaDownloadStatus","MAWTimedJob","MediaDownloadMediator","Promise","WADirectPath","WAJobOrchestratorTypes","WAMediaUtils","WAResultOrError","cr:9789","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(a,b,c,e){if(b!=null){d("MAWBridgeFireAndForget").fireAndForget("backend","addMediaDownloadQpl",{annotations:(e=e)!=null?e:void 0,pointName:c,qplInstanceKey:b,qplType:a})}}a=function(a,e,f,g,n,o,p){c("FBLogger")("labyrinth_web").info("LSUpdateAttachmentCdnUrl: start. traceId: %s",o);(k||(k=c("ExecutionEnvironment"))).isInMainThread&&d("MAWBridgeFireAndForget").fireAndForget("backend","mediaRestoreCdnUrlResult",d("WAResultOrError").makeResult({rawDirectPath:n,rawTraceId:o}));a=d("WAMediaUtils").stringToDeliveryObjectId(f);e=p!=null&&(j||(j=d("LSIntEnum"))).unwrapIntEnum(p)===c("LSMEBTaskCreationSource").MSGR_DYI;if(e)return m(a,n);g=isNaN(parseInt(o,10))?null:parseInt(o,10);g==null&&c("FBLogger")("labyrinth_web").mustfix("LSUpdateAttachmentCdnUrl.nop: traceId is null or not a number. traceId: %s",o);f=d("MAWAsyncEBMediaDownloadPromise").retrieveMediaDownloadPayload(a);if(f==null)return(h||(h=b("Promise"))).resolve();e=d("WADirectPath").validateDirectPath(n);if(!e.success){n="Restoration url error: "+e.error+". traceId: "+((n=o)!=null?n:"null");d("MAWBridgeFireAndForget").fireAndForget("backend","updateMediaDownloadStatusByObjectId",{details:e.error,downloadStatus:e.error==="direct-path-undefined"?c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE:c("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE,objectId:a});c("FBLogger")("labyrinth_web").mustfix(n);l("fail",g,"no_restoration_cdn_url",{string:{error:"no_restoration_cdn_url"}});return(h||(h=b("Promise"))).resolve()}n=e.value;c("FBLogger")("labyrinth_web").info("LSUpdateAttachmentCdnUrl: successfully got new url. traceId: %s",o);l("point",g,"update_attachment_cdn_url_nop_success");e={deliveryObjectId:a,msgId:f.messageId,plaintextHash:f.plaintextHash,restorationCdnUrl:n,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},taskSource:(i||(i=d("I64"))).to_float(p!=null?p:(i||(i=d("I64"))).of_float(-1)),threadId:f.threadId,traceId:g};o=d("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",e);if((k||(k=c("ExecutionEnvironment"))).isInWorker&&b("cr:9789")!=null){b("cr:9789").getJobManager().fireAndForget(o);return(h||(h=b("Promise"))).resolve()}return d("MAWTimedJob").TimedUIJobStarters.fireAndForget(o)};function m(a,e){if(e==null){var f="Restoration url is empty in the response of DIY attachment restore.";c("FBLogger")("labyrinth_web").mustfix(f);d("MediaDownloadMediator").handleMIDownloadFailure(a,c("err")(f));return(h||(h=b("Promise"))).resolve()}return d("MediaDownloadMediator").handleNewCDNUrlFromMI(a,e)}a.__nop_name__="LSUpdateAttachmentCdnUrl";g["default"]=a}),98);
__d("LSUpdateAttachmentCdnUrl",["LSLogMebClientEvent.nop","LSUpdateAttachmentCdnUrl.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure] Beginning execution."),c.nativeOperation(b("LSUpdateAttachmentCdnUrl.nop"),a[0],a[1],a[2],a[3],a[4])},function(a){return d[1]=c.i64.of_float(Date.now()),d[2]=c.i64.random(),d[4]="Finishing execution. Execution time: ",d[5]=c.i64.to_string(c.i64.sub(d[1],d[0])),d[6]=" ms",d[3]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure] ",d[3],d[4],d[3],d[5],d[3],d[6]].join("")),c.i64.eq(c.i64.mod_(d[2],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[7]=",",d[8]=c.createArray(),void 0!==void 0?d[9]=(d[8].push(void 0),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure",[d[4],d[7],d[5],d[7],d[6]].join(""),d[8],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsUpdateAttachmentCdnUrlStoredProcedure";a.__tables__=[];e.exports=a}),null);